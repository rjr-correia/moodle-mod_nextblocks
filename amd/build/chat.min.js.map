{"version":3,"file":"chat.min.js","sources":["../src/chat.js"],"sourcesContent":["/**\n *\n * @module      mod_nextblocks/chat\n * @copyright   2025 Rui Correia<rjr.correia@campus.fct.unl.pt>\n * @copyright   based on work by 2024 Duarte Pereira<dg.pereira@campus.fct.unl.pt>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax'], function($, ajax) {\n    const ChatManager = {\n        lastTimestamp: 0,\n        activityId: 0,\n        fullname: '',\n\n        init: function(activityId, username) {\n            this.activityId = activityId;\n            this.fullname = username;\n            this.setupEventListeners();\n            this.loadInitialMessages();\n            this.startPolling();\n        },\n\n        setupEventListeners: function() {\n            $('.msg-form').submit((e) => {\n                e.preventDefault();\n                const message = $('#msg').val().trim();\n                if (message) {\n                    this.sendMessage(message);\n                    $('#msg').val('');\n                }\n                return false;\n            });\n        },\n\n        loadInitialMessages: function() {\n            ajax.call([{\n                methodname: 'mod_nextblocks_get_messages',\n                args: {\n                    messagecount: 50,\n                    nextblocksid: this.activityId\n                },\n                done: (messages) => {\n                    this.processMessages(messages);\n                    $('#messages').scrollTop($('#messages')[0].scrollHeight);\n                }\n            }]);\n        },\n\n        sendMessage: function(message) {\n            const timestamp = Math.floor(Date.now() / 1000);\n            ajax.call([{\n                methodname: 'mod_nextblocks_save_message',\n                args: {\n                    message: message,\n                    username: this.fullname,\n                    nextblocksid: this.activityId,\n                    timestamp: timestamp\n                },\n                done: () => {\n                    this.displayMessage({\n                        message: message,\n                        username: this.fullname,\n                        timestamp: timestamp\n                    });\n\n                    // Scroll to bottom.\n                    $('#messages').scrollTop($('#messages')[0].scrollHeight);\n                }\n            }]);\n        },\n\n        startPolling: function() {\n            setInterval(() => {\n                ajax.call([{\n                    methodname: 'mod_nextblocks_get_messages',\n                    args: {\n                        messagecount: 50,\n                        nextblocksid: this.activityId\n                    },\n                    done: this.processMessages.bind(this)\n                }]);\n            }, 3000);\n        },\n\n        processMessages: function(messages) {\n            messages.forEach(msg => {\n                if (msg.timestamp > this.lastTimestamp) {\n                    this.displayMessage(msg);\n                }\n            });\n\n            if (messages.length > 0) {\n                $('#messages').scrollTop($('#messages')[0].scrollHeight);\n            }\n        },\n\n        displayMessage: function(msg) {\n            this.lastTimestamp = Math.max(this.lastTimestamp, msg.timestamp);\n            const date = new Date(msg.timestamp * 1000);\n            const timeString = date.toLocaleTimeString([], {\n                hour: '2-digit',\n                minute: '2-digit',\n                hour12: false\n            });\n\n            const day = String(date.getDate()).padStart(2, '0');\n            const month = String(date.getMonth() + 1).padStart(2, '0');\n            const year = date.getFullYear();\n            const dateString = `${day}/${month}/${year}`;\n\n            $('#messages').append(`\n                <div class=\"message\">\n                    <div class=\"message-header\">\n                        <span class=\"user\">${msg.username}</span>\n                        <span class=\"time\">${timeString} ${dateString}</span>\n                    </div>\n                    <div class=\"message-text\">${msg.message}</div>\n                </div>\n            `);\n        }\n    };\n\n    return {\n        init: ChatManager.init.bind(ChatManager)\n    };\n});"],"names":["define","$","ajax","ChatManager","lastTimestamp","activityId","fullname","init","username","this","setupEventListeners","loadInitialMessages","startPolling","submit","e","preventDefault","message","val","trim","sendMessage","call","methodname","args","messagecount","nextblocksid","done","messages","processMessages","scrollTop","scrollHeight","timestamp","Math","floor","Date","now","displayMessage","setInterval","bind","forEach","msg","length","max","date","timeString","toLocaleTimeString","hour","minute","hour12","dateString","String","getDate","padStart","getMonth","getFullYear","append"],"mappings":";;;;;;;AAOAA,OAAM,sBAAC,CAAC,SAAU,cAAc,SAASC,EAAGC,MACxC,MAAMC,YAAc,CAChBC,cAAe,EACfC,WAAY,EACZC,SAAU,GAEVC,KAAM,SAASF,WAAYG,UACvBC,KAAKJ,WAAaA,WAClBI,KAAKH,SAAWE,SAChBC,KAAKC,sBACLD,KAAKE,sBACLF,KAAKG,cACR,EAEDF,oBAAqB,WACjBT,EAAE,aAAaY,QAAQC,IACnBA,EAAEC,iBACF,MAAMC,QAAUf,EAAE,QAAQgB,MAAMC,OAKhC,OAJIF,UACAP,KAAKU,YAAYH,SACjBf,EAAE,QAAQgB,IAAI,MAEX,IAEd,EAEDN,oBAAqB,WACjBT,KAAKkB,KAAK,CAAC,CACPC,WAAY,8BACZC,KAAM,CACFC,aAAc,GACdC,aAAcf,KAAKJ,YAEvBoB,KAAOC,WACHjB,KAAKkB,gBAAgBD,UACrBzB,EAAE,aAAa2B,UAAU3B,EAAE,aAAa,GAAG4B,iBAGtD,EAEDV,YAAa,SAASH,SAClB,MAAMc,UAAYC,KAAKC,MAAMC,KAAKC,MAAQ,KAC1ChC,KAAKkB,KAAK,CAAC,CACPC,WAAY,8BACZC,KAAM,CACFN,QAASA,QACTR,SAAUC,KAAKH,SACfkB,aAAcf,KAAKJ,WACnByB,UAAWA,WAEfL,KAAMA,KACFhB,KAAK0B,eAAe,CAChBnB,QAASA,QACTR,SAAUC,KAAKH,SACfwB,UAAWA,YAIf7B,EAAE,aAAa2B,UAAU3B,EAAE,aAAa,GAAG4B,iBAGtD,EAEDjB,aAAc,WACVwB,aAAY,KACRlC,KAAKkB,KAAK,CAAC,CACPC,WAAY,8BACZC,KAAM,CACFC,aAAc,GACdC,aAAcf,KAAKJ,YAEvBoB,KAAMhB,KAAKkB,gBAAgBU,KAAK5B,WAErC,IACN,EAEDkB,gBAAiB,SAASD,UACtBA,SAASY,SAAQC,MACTA,IAAIT,UAAYrB,KAAKL,eACrBK,KAAK0B,eAAeI,QAIxBb,SAASc,OAAS,GAClBvC,EAAE,aAAa2B,UAAU3B,EAAE,aAAa,GAAG4B,aAElD,EAEDM,eAAgB,SAASI,KACrB9B,KAAKL,cAAgB2B,KAAKU,IAAIhC,KAAKL,cAAemC,IAAIT,WACtD,MAAMY,KAAO,IAAIT,KAAqB,IAAhBM,IAAIT,WACpBa,WAAaD,KAAKE,mBAAmB,GAAI,CAC3CC,KAAM,UACNC,OAAQ,UACRC,QAAQ,IAMNC,WAAa,GAHPC,OAAOP,KAAKQ,WAAWC,SAAS,EAAG,QACjCF,OAAOP,KAAKU,WAAa,GAAGD,SAAS,EAAG,QACzCT,KAAKW,gBAGlBpD,EAAE,aAAaqD,OAAO,yIAGWf,IAAI/B,+DACJmC,cAAcK,gGAEXT,IAAIvB,sDAG5C,GAGJ,MAAO,CACHT,KAAMJ,YAAYI,KAAK8B,KAAKlC,aAEpC"}